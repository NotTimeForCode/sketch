/* Good resource on canvas api:
   http://simon.html5.org/dump/html5-canvas-cheat-sheet.html
   https://developer.mozilla.org/en/drawing_text_using_a_canvas
*/(function(a){function g(a){var b,c,d,g;this.element=d=document.createElement("canvas"),this.context=g=d.getContext("2d"),this.screenshots=c=[],this.lastCoords=[],this.thisInstance=b=this,d.className="sketch-canvas",this.options=a=f({width:320,height:480,fullscreen:!1,backgroundColor:"white",lineJoin:"round",lineCap:"round",fontFamily:"arial",fontSize:"20px"},a||{}),a.fullscreen?(d.width=window.innerWidth,d.height=window.innerHeight):(d.width=a.width,d.height=a.height),e(["fillStyle","lineJoin","lineCap"],function(b){d[b]=a[b]}),this.setListener=function(a){var c=a.offsetX,d=a.offsetY,e,f=a.target,h=function(b){a=b};f.addEventListener("mousemove",h,!1),g.beginPath(),b._addPoint(a),e=setInterval(function(){b._addPoint(a)},50),f.addEventListener("touchend",function(){clearInterval(e)},!1),f.addEventListener("mouseup",function(a){f.removeEventListener("mousemove",h,!1),clearInterval(e)},!1)},this.clear(),d.addEventListener("touchmove",function(a){a.preventDefault()},!1),d.addEventListener("webkitTransitionEnd",function(a){a.propertyName==="opacity"&&(a.returnValue===!0?d.style.display="none":d.style.display="block")},!1),this.startListen(),document.body.appendChild(d)}function f(a,b){e(b,function(b,c){a[c]=b});return a}function e(a,b,c){var e;if(!a)return 0;c=c?c:a;if(d(a.length)){for(e=0;e<a.length;e++)if(b.call(c,a[e],e,a)===!1)return 0}else for(e in a)if(a.hasOwnProperty(e)&&b.call(c,a[e],e,a)===!1)return 0;return 1}function d(a,b){a=typeof a;return b?a==b:a!="undefined"}function c(a){return document.getElementById(a)}var b;b=navigator.userAgent,a.isOpera=isOpera=window.opera&&opera.buildNumber,a.isWebKit=isWebKit=/WebKit/.test(b),a.isIE=isIE=!isWebKit&&!isOpera&&/MSIE/gi.test(b)&&/Explorer/gi.test(navigator.appName),a.isGecko=isGecko=!isWebKit&&/Gecko/.test(b),a.isMobile=b.indexOf("Mobile")!==-1,e(["canvas","fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","strokeStyle","textAlign","textBaseline"],function(a,b){g.prototype[a]=function(){this.thisInstance.context[a]=arguments[0];return this.thisInstance}}),e(["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","drawImage","fill","fillRect","fillText","lineTo","moveTo","quadraticCurveTo","rect","restore","rotate","save","scale","setTransform","stroke","strokeRect","strokeText","transform","translate"],function(a,b){g.prototype[a]=function(){this.thisInstance.context[a].apply(this.thisInstance.context,arguments);return this.thisInstance}}),g.prototype.chain=function(a,b){var c=this;this[a]=function(){b.call(c);return c}},f(a,{$:c,is:d,each:e,extend:f,Canvas:g}),f(a.Canvas.prototype,{startListen:function(){this.element.addEventListener(a.isMobile?"touchstart":"mousedown",this.setListener,!1)},stopListen:function(){this.element.removeEventListener(a.isMobile?"touchstart":"mousedown",this.setListener,!1)},saveScreenshot:function(){this.screenshots.push(this.element.toDataURL("image/png"));return this},loadImage:function(b,c,d,e){var f,b,g,h;c||(c=0),d||(d=0),f=this,h=function(){f.context.drawImage(b,c,d),e&&e(f)},a.is(b,"string")?(g=b,b=document.createElement("img"),b.onload=h,b.src=g):h();return this},popScreenshot:function(a){return this.screenshots.length?this.loadImage(this.screenshots.pop(),0,0,a):this},applyScreenshot:function(a){return this.screenshots.length?this.load(this.screenshots[this.screenshots.length-1],0,0,a):this},clear:function(a){var b=this.context,c=b.fillStyle;a?this.element.width=this.element.width:(b.fillStyle=this.options.backgroundColor,b.fillRect(0,0,this.element.width,this.element.height),b.fillStyle=c);return this},_addPoint:function(a){var b,c,d;"touches"in a?(b=a.touches[0],c=b.clientX,d=b.clientY):(c=a.clientX,d=a.clientY),c!==this.lastCoords[0]&&d!==this.lastCoords[1]&&(this.context.lineTo(c,d),this.context.moveTo(c,d),this.context.closePath(),this.context.stroke(),this.lastCoords=[c,d])},hide:function(){var a=this.element,b=a.style;a.className+=" sketch-hide"},show:function(){var a=this.element,b=a.style;a.style.display="block",a.className=a.className.replace(/sketch-hide/,"");return this},fontSize:function(a){this.context.font=a+" "+this.context.font.split(" ")[1];return this},measureText:function(a){return this.context.measureText(a)},returnImage:function(a,b,c){window.location.href=this.element.toDataURL("image/png").replace("image/png","image/octet-stream")}}),window.sketch=a})({})